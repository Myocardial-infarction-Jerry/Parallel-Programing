# Parallel-Programming Task10

<center><div style='height:2mm;'></div><div style="font-family:åŽæ–‡æ¥·ä½“;font-size:14pt;">åˆ˜æ£®å…ƒ, 21307289</div></center>
<center><span style="font-family:åŽæ–‡æ¥·ä½“;font-size:9pt;line-height:9mm">ä¸­å±±å¤§å­¦è®¡ç®—æœºå­¦é™¢</span>
</center>

Codes on https://github.com/Myocardial-infarction-Jerry/Parallel-Programming/tree/main/Task10.

Project built by CMake.

```shell
> cd Task10
> cmake . && make
> bin/CUDAMatMul <size>
```

## Environment

11th Gen Intel(R) Core(TM) i7-11700KF @ 3.60GHz

NVIDIA GeForce RTX 3080 Ti O12G

Windows Subsystem for Linux @ Ubuntu 22.04 LTS

## Taskï¼šCUDA å¹¶è¡ŒçŸ©é˜µä¹˜æ³•

> CUDAå®žçŽ°å¹¶è¡Œé€šç”¨çŸ©é˜µä¹˜æ³•ï¼Œå¹¶é€šè¿‡å®žéªŒåˆ†æžä¸åŒçº¿ç¨‹å—å¤§å°ï¼Œè®¿å­˜æ–¹å¼ã€æ•°æ®/ä»»åŠ¡åˆ’åˆ†æ–¹å¼å¯¹å¹¶è¡Œæ€§èƒ½çš„å½±å“ã€‚
>
> ***è¾“å…¥ï¼š***ð‘š,ð‘›,ð‘˜ä¸‰ä¸ªæ•´æ•°ï¼Œæ¯ä¸ªæ•´æ•°çš„å–å€¼èŒƒå›´å‡ä¸º[128, 2048]
>
> ***é—®é¢˜æè¿°ï¼š***éšæœºç”Ÿæˆð‘šÃ—ð‘›çš„çŸ©é˜µð´åŠð‘›Ã—ð‘˜çš„çŸ©é˜µðµï¼Œå¹¶å¯¹è¿™ä¸¤ä¸ªçŸ©é˜µè¿›è¡ŒçŸ©é˜µä¹˜æ³•è¿ç®—ï¼Œå¾—åˆ°çŸ©é˜µð¶.
>
> ***è¾“å‡ºï¼š***ð´,ðµ,ð¶ä¸‰ä¸ªçŸ©é˜µï¼ŒåŠçŸ©é˜µè®¡ç®—æ‰€æ¶ˆè€—çš„æ—¶é—´ð‘¡ã€‚
>
> ***è¦æ±‚ï¼š***ä½¿ç”¨CUDAå®žçŽ°å¹¶è¡ŒçŸ©é˜µä¹˜æ³•ï¼Œåˆ†æžä¸åŒçº¿ç¨‹å—å¤§å°ï¼ŒçŸ©é˜µè§„æ¨¡ï¼Œè®¿å­˜æ–¹å¼ï¼Œä»»åŠ¡/æ•°æ®åˆ’åˆ†æ–¹å¼ï¼Œå¯¹ç¨‹åºæ€§èƒ½çš„å½±å“ã€‚

## Theory

### å¹¶è¡Œè®¡ç®—ç†è®ºä¸ŽCUDAæ¨¡åž‹

1. **çº¿ç¨‹ã€å—å’Œç½‘æ ¼**ï¼š
   - CUDAä¸­çš„åŸºæœ¬å¹¶è¡Œå•ä½æ˜¯çº¿ç¨‹ã€‚å¤šä¸ªçº¿ç¨‹ç»„åˆæˆä¸€ä¸ªçº¿ç¨‹å—ï¼ˆBlockï¼‰ï¼Œè€Œå¤šä¸ªçº¿ç¨‹å—ç»„åˆæˆä¸€ä¸ªç½‘æ ¼ï¼ˆGridï¼‰ã€‚è¿™ç§å±‚æ¬¡çš„ç»„ç»‡æ–¹å¼å…è®¸é«˜åº¦çµæ´»çš„å¹¶è¡Œè®¡ç®—ï¼Œé€‚åº”ä¸åŒè§„æ¨¡å’Œå¤æ‚åº¦çš„è®¡ç®—ä»»åŠ¡ã€‚
   - çº¿ç¨‹çš„ç´¢å¼•ç”±`blockIdx`, `blockDim` å’Œ `threadIdx` ç­‰ç¡®å®šã€‚
2. **å†…å­˜è®¿é—®æ¨¡å¼**ï¼š
   - **å…±äº«å†…å­˜ä¸Žå…¨å±€å†…å­˜**ï¼šCUDAä¸­ï¼Œå…±äº«å†…å­˜çš„è®¿é—®é€Ÿåº¦è¿œå¿«äºŽå…¨å±€å†…å­˜ã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼ŒçŸ©é˜µå…ƒç´ ç›´æŽ¥ä»Žå…¨å±€å†…å­˜è¯»å–å’Œå†™å…¥ï¼Œæ²¡æœ‰ä½¿ç”¨å…±äº«å†…å­˜ã€‚è¿™å¯èƒ½ä¸æ˜¯æœ€ä¼˜çš„å†…å­˜è®¿é—®ç­–ç•¥ï¼Œå› ä¸ºå…¨å±€å†…å­˜è®¿é—®å¯èƒ½å¯¼è‡´è¾ƒé«˜çš„å»¶è¿Ÿå’Œå†…å­˜å¸¦å®½çš„ç“¶é¢ˆã€‚
   - **å†…å­˜è®¿é—®æ¨¡å¼çš„å½±å“**ï¼šå†…å­˜è®¿é—®å¯†é›†åž‹çš„æ“ä½œåœ¨å†™å…¥æ“ä½œæ—¶å¯èƒ½ä¸æ˜¯è¿žç»­çš„ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å…¨å±€å†…å­˜è®¿é—®æ•ˆçŽ‡ä¸‹é™ã€‚
3. **æ ¸å‡½æ•°æ‰§è¡Œä¸ŽåŒæ­¥**ï¼š
   - **æ ¸å‡½æ•°ï¼ˆKernelï¼‰**ï¼šæ ¸å‡½æ•°ç”±GPUä¸Šçš„å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚æ¯æ¬¡æ‰§è¡Œæ ¸å‡½æ•°æ—¶ï¼Œéƒ½ä¼šåœ¨è®¾å®šçš„ç½‘æ ¼å’Œå—çš„ç»´åº¦ä¸Šå¯åŠ¨çº¿ç¨‹ã€‚
   - **è®¾å¤‡åŒæ­¥**ï¼š`cudaDeviceSynchronize()`å‡½æ•°è°ƒç”¨ç¡®ä¿GPUå®Œæˆæ‰€æœ‰çº¿ç¨‹çš„æ‰§è¡Œï¼Œä¹‹åŽæ‰èƒ½è¿›è¡Œæ—¶é—´è®¡ç®—å’Œæ•°æ®å›žä¼ ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºGPUä¸Šçš„æ ¸å‡½æ•°æ‰§è¡Œæ˜¯å¼‚æ­¥çš„ã€‚

### æ€§èƒ½è€ƒè™‘
- **æ•°æ®ä¼ è¾“**ï¼šæ•°æ®ä»Žä¸»æœºï¼ˆCPUï¼‰åˆ°è®¾å¤‡ï¼ˆGPUï¼‰çš„ä¼ è¾“åœ¨æ€§èƒ½ä¸Šæ˜¯ä¸€ä¸ªç“¶é¢ˆï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°ä¸»å­˜å’ŒGPUå­˜å‚¨å™¨ä¹‹é—´çš„æ•°æ®ç§»åŠ¨ã€‚åœ¨å®žé™…åº”ç”¨ä¸­ï¼Œå‡å°‘æ•°æ®ä¼ è¾“æ¬¡æ•°å’Œä¼˜åŒ–æ•°æ®ä¼ è¾“æ¨¡å¼æ˜¯æé«˜æ€§èƒ½çš„å…³é”®ã€‚
- **å¹¶è¡Œç²’åº¦**ï¼šé€‰æ‹©åˆé€‚çš„å—å¤§å°å’Œå½¢çŠ¶å¯¹æ€§èƒ½æœ‰é‡è¦å½±å“ã€‚ç†æƒ³çš„å—å¤§å°åº”è¯¥èƒ½å¤Ÿæœ€å¤§åŒ–å¤„ç†å™¨æ ¸å¿ƒçš„åˆ©ç”¨çŽ‡ï¼ŒåŒæ—¶å‡å°‘çº¿ç¨‹é—´çš„å†²çªå’Œç­‰å¾…ã€‚

## Code

> [!CAUTION]
>
> æºä»£ç è¯¦è§ [CUDAMatMul.cu](https://github.com/Myocardial-infarction-Jerry/Parallel-Programming/blob/main/Task10/src/CUDAMatMul.cu)

```cpp
__global__ void matMul(float *A, float *B, float *C, int size) {
    int row = blockIdx.y * blockDim.y + threadIdx.y;
    int col = blockIdx.x * blockDim.x + threadIdx.x;

    if (row >= size || col >= size)
        return;

    float sum = 0;
    for (int i = 0; i < size; ++i)
        sum += A[row * size + i] * B[i * size + col];

    C[row * size + col] = sum;
}

__global__ void matMulShared(float *A, float *B, float *C, int size) {
    __shared__ float s_A[DIM][DIM];
    __shared__ float s_B[DIM][DIM];

    int row = blockIdx.y * blockDim.y + threadIdx.y;
    int col = blockIdx.x * blockDim.x + threadIdx.x;

    float sum = 0;
    for (int i = 0; i < size / DIM; ++i) {
        s_A[threadIdx.y][threadIdx.x] = A[row * size + i * DIM + threadIdx.x];
        s_B[threadIdx.y][threadIdx.x] = B[(i * DIM + threadIdx.y) * size + col];
        __syncthreads();

        for (int j = 0; j < DIM; ++j)
            sum += s_A[threadIdx.y][j] * s_B[j][threadIdx.x];
        __syncthreads();
    }

    C[row * size + col] = sum;
}
```

## Result

ä»¥ `dim(16, 16)` ä»¥åŠ 2048 çŸ©é˜µä¸ºä¾‹

![image-20240528004053298](/Users/qiu_nangong/Library/Application Support/typora-user-images/image-20240528004053298.png)

é’ˆå¯¹ä¸åŒçº¿ç¨‹å—å¤§å°ï¼Œå– 2048 çŸ©é˜µ

| Dim Block Size | Global Mem | Shared Mem |
| -------------- | ---------- | ---------- |
| 4              | 20.1144    | 35.0394    |
| 8              | 9.51472    | 7.68102    |
| 16             | 7.61709    | 5.75898    |
| 32             | 8.42746    | 6.3191     |

é’ˆå¯¹çŸ©é˜µè§„æ¨¡ï¼Œå– `dim(16, 16)`

| Matrix Size | Global Mem | Shared Mem |
| ----------- | ---------- | ---------- |
| 512         | 0.130016   | 0.10016    |
| 1024        | 0.969728   | 0.745472   |
| 2048        | 7.61856    | 5.7559     |
| 4096        | 60.5256    | 45.0529    |

![data](/Users/qiu_nangong/Documents/GitHub/Parallel-Programming/Task10/res/data.jpg)

1. **çº¿ç¨‹å—å¤§å° (Thread Block Size)**

é¡¹ç›®ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹å—å¤§å°æ¥å®žçŽ°å¹¶è¡ŒçŸ©é˜µä¹˜æ³•ã€‚çº¿ç¨‹å—çš„å¤§å°ç›´æŽ¥å½±å“åˆ°æ ¸å‡½æ•°çš„æ‰§è¡Œæ•ˆçŽ‡å’ŒGPUèµ„æºçš„åˆ©ç”¨çŽ‡ã€‚ç†æƒ³çš„çº¿ç¨‹å—å¤§å°åº”è¯¥æ˜¯èƒ½å¤Ÿæœ€å¤§åŒ–å¤„ç†å™¨æ ¸å¿ƒçš„åˆ©ç”¨çŽ‡ï¼ŒåŒæ—¶å‡å°‘çº¿ç¨‹é—´çš„å†²çªå’Œç­‰å¾…æ—¶é—´ã€‚é€‰æ‹©è¿‡å¤§æˆ–è¿‡å°çš„çº¿ç¨‹å—å¤§å°éƒ½å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸ä½³ï¼Œå› ä¸ºå¤ªå°å¯èƒ½å¯¼è‡´GPUå¹¶è¡Œèƒ½åŠ›æœªè¢«å……åˆ†åˆ©ç”¨ï¼Œå¤ªå¤§åˆ™å¯èƒ½å¯¼è‡´èµ„æºåˆ†é…ä¸å‡å’Œæ›´å¤šçš„çº¿ç¨‹ç­‰å¾…ã€‚

2. **çŸ©é˜µè§„æ¨¡ (Matrix Size)**

çŸ©é˜µçš„å¤§å°ç›´æŽ¥å½±å“å¹¶è¡Œè®¡ç®—çš„å¤æ‚åº¦ã€‚è¾ƒå¤§çš„çŸ©é˜µéœ€è¦æ›´å¤šçš„è®¡ç®—èµ„æºå’Œå†…å­˜å¸¦å®½ï¼Œä½†åŒæ—¶ä¹Ÿæä¾›äº†æ›´é«˜çš„å¹¶è¡Œåº¦å’Œå¯èƒ½çš„æ€§èƒ½æå‡ã€‚çŸ©é˜µè§„æ¨¡çš„å¢žåŠ é€šå¸¸éœ€è¦æ›´ç²¾ç»†çš„å†…å­˜ç®¡ç†å’Œè®¡ç®—ç­–ç•¥ï¼Œä»¥é¿å…å†…å­˜è®¿é—®ç“¶é¢ˆå’Œèµ„æºæµªè´¹ã€‚

3. **è®¿å­˜æ–¹å¼ (Memory Access Patterns)**

ä½ çš„ä»£ç ä¸­æåˆ°äº†ä¸»è¦ä½¿ç”¨å…¨å±€å†…å­˜ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨å…±äº«å†…å­˜ã€‚å…¨å±€å†…å­˜çš„è®¿é—®å»¶è¿Ÿè¾ƒé«˜ï¼Œä¸”å¦‚æžœè®¿é—®æ¨¡å¼ä¸è¿žç»­ï¼Œå¯èƒ½å¯¼è‡´æ˜¾è‘—çš„æ€§èƒ½ä¸‹é™ã€‚ä½¿ç”¨å…±äº«å†…å­˜å¯ä»¥æ˜¾è‘—å‡å°‘è®¿é—®å»¶è¿Ÿï¼Œç‰¹åˆ«æ˜¯å¯¹äºŽé¢‘ç¹è®¿é—®çš„æ•°æ®ã€‚ä¼˜åŒ–å†…å­˜è®¿é—®æ¨¡å¼ï¼Œæ¯”å¦‚é€šè¿‡ä½¿ç”¨å…±äº«å†…å­˜æˆ–ä¼˜åŒ–å…¨å±€å†…å­˜è®¿é—®çš„è¿žç»­æ€§ï¼Œå¯ä»¥æ˜¾è‘—æé«˜æ€§èƒ½ã€‚

4. **ä»»åŠ¡/æ•°æ®åˆ’åˆ†æ–¹å¼ (Task/Data Partitioning)**

åˆç†çš„ä»»åŠ¡å’Œæ•°æ®åˆ’åˆ†å¯¹äºŽæé«˜CUDAç¨‹åºçš„æ•ˆçŽ‡è‡³å…³é‡è¦ã€‚æ•°æ®åº”å½“æŒ‰ç…§èƒ½å¤Ÿæœ€å¤§åŒ–å¹¶è¡Œåº¦å’Œæœ€å°åŒ–è·¨çº¿ç¨‹é€šä¿¡çš„æ–¹å¼è¿›è¡Œåˆ’åˆ†ã€‚ä¸åˆç†çš„åˆ’åˆ†å¯èƒ½å¯¼è‡´æŸäº›æ ¸å¿ƒç©ºé—²è€Œå…¶ä»–æ ¸å¿ƒè¿‡è½½ï¼Œä»Žè€Œé™ä½Žäº†æ•´ä½“çš„æ‰§è¡Œæ•ˆçŽ‡ã€‚
