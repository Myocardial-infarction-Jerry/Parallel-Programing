# Parallel-Programming Task9

<center><div style='height:2mm;'></div><div style="font-family:åæ–‡æ¥·ä½“;font-size:14pt;">åˆ˜æ£®å…ƒ, 21307289</div></center>
<center><span style="font-family:åæ–‡æ¥·ä½“;font-size:9pt;line-height:9mm">ä¸­å±±å¤§å­¦è®¡ç®—æœºå­¦é™¢</span>
</center>

Codes on https://github.com/Myocardial-infarction-Jerry/Parallel-Programming/tree/main/Task9.

Project built by CMake.

```shell
> cd Task9
> cmake . && make
> bin/CUDAMatTp <n>
> ctest -V
```

## Environment

11th Gen Intel(R) Core(TM) i7-11700KF @ 3.60GHz

NVIDIA GeForce RTX 3080 Ti O12G

Windows Subsystem for Linux @ Ubuntu 22.04 LTS

## Task

### CUDA Hello World

> [!NOTE]
>
> æœ¬å®éªŒä¸ºCUDAå…¥é—¨ç»ƒä¹ ï¼Œç”±å¤šä¸ªçº¿ç¨‹å¹¶è¡Œè¾“å‡ºâ€œHello Worldï¼â€ã€‚
>
> ***è¾“å…¥ï¼š***ä¸‰ä¸ªæ•´æ•°ğ‘›,ğ‘š,ğ‘˜ï¼Œå…¶å–å€¼èŒƒå›´ä¸º[1,32]
>
> ***é—®é¢˜æè¿°ï¼š***åˆ›å»ºğ‘›ä¸ªçº¿ç¨‹å—ï¼Œæ¯ä¸ªçº¿ç¨‹å—çš„ç»´åº¦ä¸ºğ‘šÃ—ğ‘˜ï¼Œæ¯ä¸ªçº¿ç¨‹å‡è¾“å‡ºçº¿ç¨‹å—ç¼–å·ã€äºŒç»´å—å†…çº¿ç¨‹ç¼–å·åŠHello Worldï¼ï¼ˆå¦‚ï¼Œâ€œHello World from Thread (1, 2) in Block 10!â€ï¼‰ã€‚ä¸»çº¿ç¨‹è¾“å‡ºâ€œHello World from the host!â€ã€‚
>
> ***è¦æ±‚ï¼š***å®Œæˆä¸Šè¿°å†…å®¹ï¼Œè§‚å¯Ÿè¾“å‡ºï¼Œå¹¶å›ç­”çº¿ç¨‹è¾“å‡ºé¡ºåºæ˜¯å¦æœ‰è§„å¾‹ï¼Ÿ

### CUDA çŸ©é˜µè½¬ç½®

> [!NOTE]
>
> ä½¿ç”¨CUDAå¯¹çŸ©é˜µè¿›è¡Œå¹¶è¡Œè½¬ç½®ã€‚
>
> ***è¾“å…¥ï¼š***æ•´æ•°ğ‘›ï¼Œå…¶å–å€¼èŒƒå›´å‡ä¸º[512, 2048]
>
> ***é—®é¢˜æè¿°ï¼š***éšæœºç”Ÿæˆğ‘›Ã—ğ‘›çš„çŸ©é˜µğ´ï¼Œå¯¹å…¶è¿›è¡Œè½¬ç½®å¾—åˆ°ğ´ğ‘‡ã€‚è½¬ç½®çŸ©é˜µä¸­ç¬¬ğ‘–è¡Œğ‘—åˆ—ä¸Šçš„å…ƒç´ ä¸ºåŸçŸ©é˜µä¸­ğ‘—è¡Œğ‘–åˆ—å…ƒç´ ï¼Œå³ğ´ğ‘–ğ‘—ğ‘‡=ğ´ğ‘—ğ‘–ã€‚
>
> ***è¾“å‡ºï¼š***çŸ©é˜µğ´åŠå…¶è½¬ç½®çŸ©é˜µğ´ğ‘‡ï¼ŒåŠè®¡ç®—æ‰€æ¶ˆè€—çš„æ—¶é—´ğ‘¡ã€‚
>
> ***è¦æ±‚ï¼š***ä½¿ç”¨CUDAå®ç°å¹¶è¡ŒçŸ©é˜µè½¬ç½®ï¼Œåˆ†æä¸åŒçº¿ç¨‹å—å¤§å°ï¼ŒçŸ©é˜µè§„æ¨¡ï¼Œè®¿å­˜æ–¹å¼ï¼ˆå…¨å±€å†…å­˜è®¿é—®ï¼Œå…±äº«å†…å­˜è®¿é—®ï¼‰ï¼Œä»»åŠ¡/æ•°æ®åˆ’åˆ†å’Œæ˜ å°„æ–¹å¼ï¼Œå¯¹ç¨‹åºæ€§èƒ½çš„å½±å“ã€‚

## Theory

### å¹¶è¡Œè®¡ç®—ç†è®ºä¸CUDAæ¨¡å‹

1. **çº¿ç¨‹ã€å—å’Œç½‘æ ¼**ï¼š
   - CUDAä¸­çš„åŸºæœ¬å¹¶è¡Œå•ä½æ˜¯çº¿ç¨‹ã€‚å¤šä¸ªçº¿ç¨‹ç»„åˆæˆä¸€ä¸ªçº¿ç¨‹å—ï¼ˆBlockï¼‰ï¼Œè€Œå¤šä¸ªçº¿ç¨‹å—ç»„åˆæˆä¸€ä¸ªç½‘æ ¼ï¼ˆGridï¼‰ã€‚è¿™ç§å±‚æ¬¡çš„ç»„ç»‡æ–¹å¼å…è®¸é«˜åº¦çµæ´»çš„å¹¶è¡Œè®¡ç®—ï¼Œé€‚åº”ä¸åŒè§„æ¨¡å’Œå¤æ‚åº¦çš„è®¡ç®—ä»»åŠ¡ã€‚
   - çº¿ç¨‹çš„ç´¢å¼•ç”±`blockIdx`, `blockDim` å’Œ `threadIdx` ç­‰ç¡®å®šã€‚
2. **å†…å­˜è®¿é—®æ¨¡å¼**ï¼š
   - **å…±äº«å†…å­˜ä¸å…¨å±€å†…å­˜**ï¼šCUDAä¸­ï¼Œå…±äº«å†…å­˜çš„è®¿é—®é€Ÿåº¦è¿œå¿«äºå…¨å±€å†…å­˜ã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼ŒçŸ©é˜µå…ƒç´ ç›´æ¥ä»å…¨å±€å†…å­˜è¯»å–å’Œå†™å…¥ï¼Œæ²¡æœ‰ä½¿ç”¨å…±äº«å†…å­˜ã€‚è¿™å¯èƒ½ä¸æ˜¯æœ€ä¼˜çš„å†…å­˜è®¿é—®ç­–ç•¥ï¼Œå› ä¸ºå…¨å±€å†…å­˜è®¿é—®å¯èƒ½å¯¼è‡´è¾ƒé«˜çš„å»¶è¿Ÿå’Œå†…å­˜å¸¦å®½çš„ç“¶é¢ˆã€‚
   - **å†…å­˜è®¿é—®æ¨¡å¼çš„å½±å“**ï¼šå†…å­˜è®¿é—®å¯†é›†å‹çš„æ“ä½œåœ¨å†™å…¥æ“ä½œæ—¶å¯èƒ½ä¸æ˜¯è¿ç»­çš„ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å…¨å±€å†…å­˜è®¿é—®æ•ˆç‡ä¸‹é™ã€‚
3. **æ ¸å‡½æ•°æ‰§è¡Œä¸åŒæ­¥**ï¼š
   - **æ ¸å‡½æ•°ï¼ˆKernelï¼‰**ï¼šæ ¸å‡½æ•°ç”±GPUä¸Šçš„å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚æ¯æ¬¡æ‰§è¡Œæ ¸å‡½æ•°æ—¶ï¼Œéƒ½ä¼šåœ¨è®¾å®šçš„ç½‘æ ¼å’Œå—çš„ç»´åº¦ä¸Šå¯åŠ¨çº¿ç¨‹ã€‚
   - **è®¾å¤‡åŒæ­¥**ï¼š`cudaDeviceSynchronize()`å‡½æ•°è°ƒç”¨ç¡®ä¿GPUå®Œæˆæ‰€æœ‰çº¿ç¨‹çš„æ‰§è¡Œï¼Œä¹‹åæ‰èƒ½è¿›è¡Œæ—¶é—´è®¡ç®—å’Œæ•°æ®å›ä¼ ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºGPUä¸Šçš„æ ¸å‡½æ•°æ‰§è¡Œæ˜¯å¼‚æ­¥çš„ã€‚

### æ€§èƒ½è€ƒè™‘
- **æ•°æ®ä¼ è¾“**ï¼šæ•°æ®ä»ä¸»æœºï¼ˆCPUï¼‰åˆ°è®¾å¤‡ï¼ˆGPUï¼‰çš„ä¼ è¾“åœ¨æ€§èƒ½ä¸Šæ˜¯ä¸€ä¸ªç“¶é¢ˆï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°ä¸»å­˜å’ŒGPUå­˜å‚¨å™¨ä¹‹é—´çš„æ•°æ®ç§»åŠ¨ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå‡å°‘æ•°æ®ä¼ è¾“æ¬¡æ•°å’Œä¼˜åŒ–æ•°æ®ä¼ è¾“æ¨¡å¼æ˜¯æé«˜æ€§èƒ½çš„å…³é”®ã€‚
- **å¹¶è¡Œç²’åº¦**ï¼šé€‰æ‹©åˆé€‚çš„å—å¤§å°å’Œå½¢çŠ¶å¯¹æ€§èƒ½æœ‰é‡è¦å½±å“ã€‚ç†æƒ³çš„å—å¤§å°åº”è¯¥èƒ½å¤Ÿæœ€å¤§åŒ–å¤„ç†å™¨æ ¸å¿ƒçš„åˆ©ç”¨ç‡ï¼ŒåŒæ—¶å‡å°‘çº¿ç¨‹é—´çš„å†²çªå’Œç­‰å¾…ã€‚

## Code

### CUDA Hello World

> [!CAUTION]
>
> æºä»£ç è¯¦è§ [CUDAHelloWorld.cu](https://github.com/Myocardial-infarction-Jerry/Parallel-Programming/blob/main/Task9/src/CUDAHelloWorld.cu)

```cpp
__global__ void helloFromGPU(int n, int m, int k) {
    int idx = blockIdx.x;
    int idy = threadIdx.y + threadIdx.x * blockDim.y;

    if (idx < n && idy < m * k) {
        printf("Hello World from Thread (%d, %d) in Block %d!\n", threadIdx.x, threadIdx.y, blockIdx.x);
    }
}
```

### CUDA çŸ©é˜µè½¬ç½®

> [!CAUTION]
>
> æºä»£ç è¯¦è§ [CUDAMatTp.cu](https://github.com/Myocardial-infarction-Jerry/Parallel-Programming/blob/main/Task9/src/CUDAMatTp.cu)

```cpp
__global__ void matTranspose(float *d_A, float *d_B, int n) {
    int i = blockIdx.x * blockDim.x + threadIdx.x;
    int j = blockIdx.y * blockDim.y + threadIdx.y;
    if (i < n && j < n) {
        d_B[j * n + i] = d_A[i * n + j];
    }
}
```

## Result

### CUDA Hello World

![image-20240521022540095](/Users/qiu_nangong/Library/Application Support/typora-user-images/image-20240521022540095.png)

åœ¨CUDAä¸­ï¼Œçº¿ç¨‹å’Œçº¿ç¨‹å—çš„è°ƒåº¦å¹¶ä¸ä¿è¯æŒ‰ç…§ç‰¹å®šçš„é¡ºåºæ‰§è¡Œã€‚è¿™æ˜¯å› ä¸ºGPUè°ƒåº¦å™¨æ ¹æ®å¯ç”¨è®¡ç®—èµ„æºåŠ¨æ€åœ°ç®¡ç†çº¿ç¨‹å—çš„æ‰§è¡Œã€‚å› æ­¤ï¼Œå°½ç®¡çº¿ç¨‹å’Œçº¿ç¨‹å—è¢«åˆ†é…äº†ç‰¹å®šçš„ç´¢å¼•ï¼Œå®ƒä»¬çš„å®é™…æ‰§è¡Œé¡ºåºå¯ä»¥æ˜¯éç¡®å®šæ€§çš„ï¼Œé€šå¸¸å–å†³äºç¡¬ä»¶çš„å…·ä½“å®ç°å’Œå½“å‰çš„å·¥ä½œè´Ÿè½½ã€‚

### CUDA çŸ©é˜µè½¬ç½®

ä»¥ 512 çŸ©é˜µä¸ºä¾‹

![image-20240521022734260](/Users/qiu_nangong/Library/Application Support/typora-user-images/image-20240521022734260.png)

æœ‰æµ‹è¯•æ•°æ®

| Size | Time     |
| ---- | -------- |
| 512  | 0.529 ms |
| 1024 | 0.862 ms |
| 2048 | 1.482 ms |

CUDAçŸ©é˜µè½¬ç½®æ˜¯ä¸€ä¸ªå¹¿æ³›ç”¨æ¥è¯„ä¼°GPUæ€§èƒ½çš„åŸºå‡†æµ‹è¯•ã€‚ä»¥ä¸‹å°†è¯¦ç»†åˆ†æä¸åŒå› ç´ å¦‚çº¿ç¨‹å—å¤§å°ã€çŸ©é˜µè§„æ¨¡ã€è®¿å­˜æ–¹å¼ç­‰å¦‚ä½•å½±å“å¹¶è¡ŒçŸ©é˜µè½¬ç½®çš„æ€§èƒ½ã€‚

1. çº¿ç¨‹å—å¤§å°ï¼ˆBlock Sizeï¼‰

   çº¿ç¨‹å—å¤§å°æ˜¯å½±å“æ€§èƒ½çš„å…³é”®å‚æ•°ä¹‹ä¸€ï¼Œå› ä¸ºå®ƒç›´æ¥å…³ç³»åˆ°æ ¸å¿ƒåˆ©ç”¨ç‡å’Œå†…å­˜è®¿é—®æ•ˆç‡ï¼š

   - **å°çº¿ç¨‹å—**ï¼šå¯èƒ½æ— æ³•å……åˆ†åˆ©ç”¨GPUçš„å¹¶è¡Œæ€§ï¼Œå› ä¸ºæ´»è·ƒçš„çº¿ç¨‹æ•°ä¸è¶³ä»¥è¦†ç›–å†…å­˜è®¿é—®å»¶è¿Ÿã€‚
   - **å¤§çº¿ç¨‹å—**ï¼šè™½ç„¶å¯ä»¥å¢åŠ å¹¶è¡Œåº¦ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´èµ„æºäº‰ç”¨ï¼Œå¦‚å¯„å­˜å™¨å’Œå…±äº«å†…å­˜çš„é™åˆ¶ï¼Œä»è€Œé™ä½æ•ˆç‡ã€‚
   - **æœ€ä¼˜å¤§å°**ï¼šä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨16x16æˆ–32x32çš„çº¿ç¨‹å—å¤§å°æ˜¯æ•ˆç‡å’Œæ€§èƒ½çš„ä¸€ä¸ªè‰¯å¥½æŠ˜è¡·ã€‚è¿™æ ·çš„å¤§å°å¯ä»¥å¾ˆå¥½åœ°æ˜ å°„åˆ°GPUçš„ç‰©ç†ç»“æ„ï¼ŒåŒæ—¶ä¿æŒè¾ƒé«˜çš„å†…å­˜è®¿é—®æ•ˆç‡ã€‚

2. çŸ©é˜µè§„æ¨¡ï¼ˆMatrix Sizeï¼‰

   çŸ©é˜µçš„å¤§å°ç›´æ¥å½±å“åˆ°å¹¶è¡Œç®—æ³•çš„æ•ˆç‡ï¼š

   - **å°çŸ©é˜µ**ï¼šå¯èƒ½ä¸éœ€è¦å¤ªå¤§çš„å¹¶è¡Œåº¦ï¼Œå°çº¿ç¨‹å—å¯èƒ½å°±è¶³å¤Ÿäº†ã€‚
   - **å¤§çŸ©é˜µ**ï¼šéœ€è¦æ›´é«˜çš„å¹¶è¡Œåº¦å’Œæ›´ç»†è‡´çš„å†…å­˜è®¿é—®ç­–ç•¥æ¥ä¼˜åŒ–æ€§èƒ½ã€‚

3. è®¿å­˜æ–¹å¼ï¼ˆMemory Access Patternsï¼‰

   è®¿é—®å†…å­˜çš„æ–¹å¼å¯¹æ€§èƒ½æœ‰æ˜¾è‘—å½±å“ï¼Œå°¤å…¶æ˜¯åœ¨çŸ©é˜µè½¬ç½®è¿™ç§é¢‘ç¹è®¿é—®å†…å­˜çš„æ“ä½œä¸­ï¼š

   - **å…¨å±€å†…å­˜è®¿é—®**ï¼šç›´æ¥ä»å…¨å±€å†…å­˜è¯»å–å’Œå†™å…¥æ•°æ®ã€‚è¿™ç§æ–¹å¼ç®€å•ï¼Œä½†ç”±äºå…¨å±€å†…å­˜è®¿é—®é€Ÿåº¦è¾ƒæ…¢ï¼Œå®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚
   - **å…±äº«å†…å­˜è®¿é—®**ï¼šä½¿ç”¨å¿«é€Ÿçš„å…±äº«å†…å­˜æ¥å‡å°‘å…¨å±€å†…å­˜è®¿é—®ã€‚ä¸€ç§å¸¸è§çš„ç­–ç•¥æ˜¯ä½¿ç”¨å…±äº«å†…å­˜ä½œä¸ºå—å†…æ•°æ®çš„ç¼“å†²åŒºï¼Œæ¯ä¸ªçº¿ç¨‹å—å…ˆå°†å…¨å±€å†…å­˜ä¸­çš„ä¸€ä¸ªçŸ©é˜µå—è¯»å…¥å…±äº«å†…å­˜ï¼Œè½¬ç½®åå†å†™å›å…¨å±€å†…å­˜ã€‚è¿™ç§æ–¹å¼å¯ä»¥æ˜¾è‘—æé«˜å†…å­˜è®¿é—®æ•ˆç‡ï¼Œå°¤å…¶æ˜¯å¯¹äºå¤§çŸ©é˜µã€‚

4. ä»»åŠ¡/æ•°æ®åˆ’åˆ†å’Œæ˜ å°„æ–¹å¼

   ä»»åŠ¡å¦‚ä½•åœ¨å¤šä¸ªçº¿ç¨‹é—´åˆ’åˆ†ä¹Ÿæä¸ºé‡è¦ï¼š

   - **ä¸€ç»´åˆ’åˆ†**ï¼šæ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€è¡Œæˆ–ä¸€åˆ—ï¼Œè¿™ç§æ–¹å¼ç®€å•ä½†å¯èƒ½å¯¼è‡´ä¸å‡åŒ€çš„å†…å­˜è®¿é—®å’Œæ€§èƒ½ä¸‹é™ã€‚
   - **äºŒç»´åˆ’åˆ†**ï¼šæ›´å¸¸è§çš„æ˜¯å°†çŸ©é˜µåˆ’åˆ†ä¸ºå°å—ï¼Œæ¯ä¸ªçº¿ç¨‹å—å¤„ç†ä¸€ä¸ªå­å—ã€‚è¿™ç§åˆ’åˆ†æ–¹å¼å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨GPUçš„å†…å­˜å±‚æ¬¡ç»“æ„ï¼Œå‡å°‘å†…å­˜è®¿é—®å»¶è¿Ÿã€‚

å¯¹CUDAçŸ©é˜µè½¬ç½®æ€§èƒ½çš„å½±å“å› ç´ æ˜¯å¤šæ–¹é¢çš„ã€‚å®é™…é€‰æ‹©æœ€ä½³ç­–ç•¥æ—¶ï¼Œé€šå¸¸éœ€è¦æ ¹æ®å…·ä½“åº”ç”¨çš„éœ€æ±‚å’ŒGPUçš„ç¡¬ä»¶ç‰¹æ€§è¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ã€‚å®éªŒä¸åŒçš„é…ç½®å’Œä¼˜åŒ–æ–¹æ³•ï¼Œæµ‹é‡å®ƒä»¬å¯¹æ€§èƒ½çš„å…·ä½“å½±å“ï¼Œå°†æœ‰åŠ©äºæ·±å…¥ç†è§£å¹¶è¡Œç®—æ³•çš„æ€§èƒ½ç“¶é¢ˆå’Œä¼˜åŒ–ç©ºé—´ã€‚
